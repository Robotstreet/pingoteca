#include "text_renderer.h"
#include <stdio.h>
#include <string.h>
#include <math.h>
#include <stdint.h>


static TextRenderer g_text_renderer = {0};

static const unsigned char font_bitmap[256][8] = {
    [32] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, /* ' ' */
    [33] = {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00}, /* '!' */
    [34] = {0x6C,0x6C,0x48,0x00,0x00,0x00,0x00,0x00}, /* '"' */
    [35] = {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00}, /* '#' */
    [36] = {0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00}, /* '$' */
    [37] = {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00}, /* '%' */
    [38] = {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00}, /* '&' */
    [39] = {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00}, /* ''' */
    [40] = {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00}, /* '(' */
    [41] = {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00}, /* ')' */
    [42] = {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, /* '*' */
    [43] = {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00}, /* '+' */
    [44] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, /* ',' */
    [45] = {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00}, /* '-' */
    [46] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, /* '.' */
    [47] = {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00}, /* '/' */

    [48] = {0x3C,0x66,0x6E,0x7E,0x76,0x66,0x3C,0x00}, /* '0' */
    [49] = {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00}, /* '1' */
    [50] = {0x3C,0x66,0x06,0x0C,0x30,0x66,0x7E,0x00}, /* '2' */
    [51] = {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00}, /* '3' */
    [52] = {0x0C,0x1C,0x3C,0x6C,0xFE,0x0C,0x1E,0x00}, /* '4' */
    [53] = {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00}, /* '5' */
    [54] = {0x3C,0x66,0x60,0x7C,0x66,0x66,0x3C,0x00}, /* '6' */
    [55] = {0x7E,0x66,0x0C,0x18,0x30,0x30,0x30,0x00}, /* '7' */
    [56] = {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00}, /* '8' */
    [57] = {0x3C,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00}, /* '9' */

    [65] = {0x3C,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, /* 'A' */
    [66] = {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00}, /* 'B' */
    [67] = {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00}, /* 'C' */
    [68] = {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00}, /* 'D' */
    [69] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00}, /* 'E' */
    [70] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00}, /* 'F' */
    [71] = {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3E,0x00}, /* 'G' */
    [72] = {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, /* 'H' */
    [73] = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, /* 'I' */
    [74] = {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00}, /* 'J' */
    [75] = {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00}, /* 'K' */
    [76] = {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00}, /* 'L' */
    [77] = {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00}, /* 'M' */
    [78] = {0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00}, /* 'N' */
    [79] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, /* 'O' */
    [80] = {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00}, /* 'P' */
    [81] = {0x3C,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00}, /* 'Q' */
    [82] = {0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00}, /* 'R' */
    [83] = {0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00}, /* 'S' */
    [84] = {0x7E,0x5A,0x18,0x18,0x18,0x18,0x3C,0x00}, /* 'T' */
    [85] = {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, /* 'U' */
    [86] = {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, /* 'V' */
    [87] = {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00}, /* 'W' */
    [88] = {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00}, /* 'X' */
    [89] = {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00}, /* 'Y' */
    [90] = {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00}, /* 'Z' */

    [97]  = {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00}, /* 'a' */
    [98]  = {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00}, /* 'b' */
    [99]  = {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00}, /* 'c' */
    [100] = {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00}, /* 'd' */
    [101] = {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00}, /* 'e' */
    [102] = {0x1C,0x36,0x30,0x7C,0x30,0x30,0x30,0x00}, /* 'f' */
    [103] = {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x7C}, /* 'g' */
    [104] = {0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x00}, /* 'h' */
    [105] = {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00}, /* 'i' */
    [106] = {0x0C,0x00,0x1C,0x0C,0x0C,0x6C,0x6C,0x38}, /* 'j' */
    [107] = {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00}, /* 'k' */
    [108] = {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, /* 'l' */
    [109] = {0x00,0x00,0x6E,0x7F,0x6B,0x63,0x63,0x00}, /* 'm' */
    [110] = {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00}, /* 'n' */
    [111] = {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00}, /* 'o' */
    [112] = {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60}, /* 'p' */
    [113] = {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06}, /* 'q' */
    [114] = {0x00,0x00,0x6C,0x76,0x60,0x60,0xF0,0x00}, /* 'r' */
    [115] = {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00}, /* 's' */
    [116] = {0x10,0x30,0x7C,0x30,0x30,0x36,0x1C,0x00}, /* 't' */
    [117] = {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00}, /* 'u' */
    [118] = {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00}, /* 'v' */
    [119] = {0x00,0x00,0x63,0x63,0x6B,0x7F,0x36,0x00}, /* 'w' */
    [120] = {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00}, /* 'x' */
    [121] = {0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x7C}, /* 'y' */
    [122] = {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00}, /* 'z' */

    [160] = {0x18,0x0C,0x3C,0x66,0x7E,0x66,0x66,0x00}, /* Á (exemplo) - índice 160 */
    [161] = {0x3C,0x66,0x60,0x60,0x66,0x3C,0x0C,0x18}, /* Ç (exemplo) - índice 161 */
    [162] = {0x18,0x0C,0x7E,0x60,0x78,0x60,0x7E,0x00}, /* É (exemplo) - índice 162 */

};

static void draw_char(char c, int x, int y, int scale, TextColor color);

static uint32_t utf8_next_codepoint(const char **pptr) {
    const unsigned char *p = (const unsigned char *)*pptr;
    if (!p || *p == '\0') return 0;
    if (p[0] < 0x80) {
        uint32_t cp = p[0];
        *pptr += 1;
        return cp;
    } else if ((p[0] & 0xE0) == 0xC0 && p[1]) {
        uint32_t cp = ((p[0] & 0x1F) << 6) | (p[1] & 0x3F);
        *pptr += 2;
        return cp;
    } else if ((p[0] & 0xF0) == 0xE0 && p[1] && p[2]) {
        uint32_t cp = ((p[0] & 0x0F) << 12) | ((p[1] & 0x3F) << 6) | (p[2] & 0x3F);
        *pptr += 3;
        return cp;
    } else if ((p[0] & 0xF8) == 0xF0 && p[1] && p[2] && p[3]) {
        uint32_t cp = ((p[0] & 0x07) << 18) | ((p[1] & 0x3F) << 12) | ((p[2] & 0x3F) << 6) | (p[3] & 0x3F);
        *pptr += 4;
        return cp;
    } else {
        (*pptr)++;
        return 0xFFFD;
    }
}

bool text_renderer_init(SDL_Renderer* renderer) {
    if (!renderer) {
        printf("Erro: Renderer SDL inválido para sistema de texto\n");
        return false;
    }
    g_text_renderer.renderer = renderer;
    g_text_renderer.font_size = 8;
    g_text_renderer.initialized = true;
    printf("Sistema de texto inicializado\n");
    return true;
}

void text_renderer_cleanup(void) {
    g_text_renderer.initialized = false;
    g_text_renderer.renderer = NULL;
    printf("Sistema de texto finalizado\n");
}

static void draw_char(char c, int x, int y, int scale, TextColor color) {
    if (!g_text_renderer.initialized || !g_text_renderer.renderer) return;

    unsigned char char_code = (unsigned char)c;
    if (char_code >= 256) char_code = 32;
    const unsigned char *bitmap = font_bitmap[char_code];

    SDL_SetRenderDrawColor(g_text_renderer.renderer, color.r, color.g, color.b, color.a);

    for (int row = 0; row < 8; row++) {
        unsigned char line = bitmap[row];
        for (int col = 0; col < 8; col++) {
            if (line & (0x80 >> col)) {
                for (int sy = 0; sy < scale; sy++) {
                    for (int sx = 0; sx < scale; sx++) {
                        SDL_RenderDrawPoint(g_text_renderer.renderer,
                                            x + col * scale + sx,
                                            y + row * scale + sy);
                    }
                }
            }
        }
    }
}

void text_render_string(const char* text, int x, int y, TextStyle style, TextColor color, TextAlign align) {
    if (!g_text_renderer.initialized || !text) return;

    int scale = 1;
    switch (style) {
        case TEXT_STYLE_SMALL: scale = 1; break;
        case TEXT_STYLE_NORMAL: scale = 2; break;
        case TEXT_STYLE_BOLD: scale = 2; break;
        case TEXT_STYLE_TITLE: scale = 3; break;
    }

    int text_width = (int)strlen(text) * 8 * scale;
    int start_x = x;

    switch (align) {
        case TEXT_ALIGN_CENTER:
            start_x = x - text_width / 2;
            break;
        case TEXT_ALIGN_RIGHT:
            start_x = x - text_width;
            break;
        default:
            break;
    }

    const char *p = text;
    int ix = 0;
    while (*p) {
        uint32_t cp = utf8_next_codepoint(&p);
        char out = '?';
        if (cp == 0) break;
        if (cp < 128) {
            out = (char)cp;
        } else {
            switch (cp) {
                case 0x00E3: case 0x00E1: case 0x00E0: out = 'a'; break; /* ã, á, à */
                case 0x0101: out = 'a'; break; /* ā - opcional */
                case 0x00E9: case 0x00EA: out = 'e'; break; /* é, ê */
                case 0x00ED: out = 'i'; break; /* í */
                case 0x00F3: case 0x00F4: case 0x00F5: out = 'o'; break; /* ó, ô, õ */
                case 0x00FA: out = 'u'; break; /* ú */
                case 0x00E7: out = 'c'; break; /* ç */
                case 0x00C3: case 0x00C1: case 0x00C0: out = 'A'; break;
                case 0x00C9: case 0x00CA: out = 'E'; break;
                case 0x00CD: out = 'I'; break;
                case 0x00D3: case 0x00D4: case 0x00D5: out = 'O'; break;
                case 0x00DA: out = 'U'; break;
                case 0x00C7: out = 'C'; break;
                default: out = '?'; break;
            }
        }

        draw_char(out, start_x + ix * 8 * scale, y, scale, color);
        ix++;
    }
}

void text_render_centered(const char* text, int x, int y, int width, TextStyle style, TextColor color) {
    text_render_string(text, x + width / 2, y, style, color, TEXT_ALIGN_CENTER);
}

void text_get_size(const char* text, TextStyle style, int* width, int* height) {
    if (!text) {
        if (width) *width = 0;
        if (height) *height = 0;
        return;
    }

    int scale = 1;
    switch (style) {
        case TEXT_STYLE_SMALL: scale = 1; break;
        case TEXT_STYLE_NORMAL: scale = 2; break;
        case TEXT_STYLE_BOLD: scale = 2; break;
        case TEXT_STYLE_TITLE: scale = 3; break;
    }

    if (width) *width = (int)strlen(text) * 8 * scale;
    if (height) *height = 8 * scale;
}
